name: Merge Coverage Reports

on:
  workflow_run:
    workflows:
      - "Crate Tests"
    types:
      - completed

jobs:
  merge-coverage:
    name: Merge Coverage Reports
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: taiki-e/install-action@cargo-llvm-cov
      - name: Download all coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: coverage-*
          path: coverage-artifacts/
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          merge-multiple: false
      - name: Install lcov
        run: |
          sudo apt-get update
          sudo apt-get install -y lcov
      - name: Merge coverage reports
        run: |
          mkdir -p merged-coverage
          find coverage-artifacts -name "*.info" -type f > coverage-files.txt
          if [ -s coverage-files.txt ]; then
            lcov -a $(head -n1 coverage-files.txt) -o merged-coverage/coverage.info
            tail -n +2 coverage-files.txt | while read file; do
              lcov -a merged-coverage/coverage.info -a "$file" -o merged-coverage/coverage-temp.info
              mv merged-coverage/coverage-temp.info merged-coverage/coverage.info
            done
          else
            echo "No coverage files found, creating empty report"
            touch merged-coverage/coverage.info
          fi
      - name: Upload merged coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-merged
          path: merged-coverage/coverage.info
          retention-days: 1

